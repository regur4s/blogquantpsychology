{% extends 'base.html' %}
{% block title %}{{ 'New' if mode == 'new' else 'Edit' }} Post - My Blog{% endblock %}
{% block content %}
  <h1>{{ 'New' if mode == 'new' else 'Edit' }} Post</h1>
  <form method="post" class="form">
    <label>Title
      <input type="text" name="title" value="{{ post.title if post else '' }}" required>
    </label>
    
    <label>Excerpt (Optional - for "Read More")
      <textarea name="excerpt" rows="3" placeholder="Brief summary for the home page...">{{ post.excerpt if post else '' }}</textarea>
    </label>
    
    <label>Category
      <select name="category_id">
        <option value="">-- No Category --</option>
        {% for category in categories %}
          <option value="{{ category.id }}" {% if post and post.category_id == category.id %}selected{% endif %}>
            {{ category.name }}
          </option>
        {% endfor %}
      </select>
    </label>
    
    <label>Tags (comma-separated)
      <input type="text" name="tags" value="{% if post %}{% for tag in post.tags %}{{ tag.name }}{% if not loop.last %}, {% endif %}{% endfor %}{% endif %}" placeholder="tag1, tag2, tag3">
    </label>
    
    <div class="editor-section">
      <label>Content (Markdown)
        <textarea name="content_md" rows="16" id="content_md">{{ post.content_md if post else '' }}</textarea>
      </label>
      
      <div class="preview-section" id="preview" style="display: none;">
        <h4>Preview:</h4>
        <div class="preview-content" id="preview-content"></div>
      </div>
      
      <div class="editor-controls">
        <button type="button" id="toggle-preview">Toggle Preview</button>
      </div>
    </div>
    
    <label class="checkbox">
      <input type="checkbox" name="published" {% if post and post.published %}checked{% endif %}> Published
    </label>
    <div class="actions">
      <button type="submit">Save</button>
      <a class="btn" href="{{ url_for('admin_dashboard') }}">Cancel</a>
    </div>
  </form>

  <script>
    // Simple live preview functionality
    const contentTextarea = document.getElementById('content_md');
    const previewDiv = document.getElementById('preview');
    const previewContent = document.getElementById('preview-content');
    const toggleButton = document.getElementById('toggle-preview');
    
    let previewVisible = false;
    
    toggleButton.addEventListener('click', () => {
      previewVisible = !previewVisible;
      if (previewVisible) {
        previewDiv.style.display = 'block';
        updatePreview();
        toggleButton.textContent = 'Hide Preview';
      } else {
        previewDiv.style.display = 'none';
        toggleButton.textContent = 'Show Preview';
      }
    });
    
    function updatePreview() {
      if (previewVisible) {
        const content = contentTextarea.value;
        // Simple markdown to HTML conversion (basic)
        let html = content
          .replace(/^# (.*$)/gim, '<h1>$1</h1>')
          .replace(/^## (.*$)/gim, '<h2>$1</h2>')
          .replace(/^### (.*$)/gim, '<h3>$1</h3>')
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>')
          .replace(/\n/g, '<br>');
        previewContent.innerHTML = html || '<p><em>Start typing to see preview...</em></p>';
      }
    }
    
    contentTextarea.addEventListener('input', updatePreview);
  </script>
{% endblock %}

